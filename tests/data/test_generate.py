# cspell:ignore tolist
from pprint import pprint

import numpy as np
import pytest
from expertsystem.amplitude.kinematics import HelicityKinematics, ReactionInfo

from tensorwaves.data.generate import generate_phsp
from tensorwaves.data.tf_phasespace import TFUniformRealNumberGenerator


def test_generate_data(data_sample: np.ndarray):
    sub_sample = data_sample[:, :5, :]
    print("Expected list, get by running pytest with the -s flag")
    pprint(np.round(sub_sample, decimals=11).tolist())
    assert pytest.approx(sub_sample) == [
        [
            [0.37918944935, 0.73396599969, 1.26106620078, 1.50757377596],
            [-0.07315064441, -0.21998573758, 1.39475985207, 1.41389525301],
            [0.06569896528, -1.51812710851, 0.0726906006, 1.52128570461],
            [1.40672331053, 0.49678572189, -0.26260603856, 1.51480310845],
            [0.79694939592, 1.29832389761, -0.03638188481, 1.52384281483],
        ],
        [
            [-0.34871369761, -0.72119471428, -1.1654765212, 1.42066087326],
            [-0.26739932067, -0.15455480956, -0.90539883872, 0.96610319301],
            [0.11616448713, 0.57584161239, -0.06714695611, 0.60647770024],
            [-0.88651015826, -0.46024226278, 0.0713099651, 1.01045883083],
            [-0.48051670276, -0.91259832182, -0.08009031815, 1.04324742713],
        ],
        [
            [-0.03047575173, -0.01277128542, -0.09558967958, 0.16866535079],
            [0.34054996508, 0.37454054715, -0.48936101336, 0.71690155399],
            [-0.18186345241, 0.94228549612, -0.00554364449, 0.96913659515],
            [-0.52021315227, -0.03654345912, 0.19129607347, 0.57163806072],
            [-0.31643269316, -0.38572557579, 0.11647220296, 0.52980975805],
        ],
    ]


@pytest.mark.parametrize(
    "initial_state_names, final_state_names, expected_sample",
    [
        (
            "J/psi(1S)",
            ("pi0", "pi0", "pi0"),
            [
                [
                    [0.799667989, 0.159823862, 0.156340839, 0.841233472],
                    [-0.364360112, -0.371962329, 0.347228344, 0.640234742],
                    [0.403805561, 0.417294074, -0.208401449, 0.631540320],
                ],
                [
                    [-0.053789754, -0.535237707, -0.947232044, 1.097652050],
                    [1.168326711, -0.060296302, -0.805136016, 1.426564296],
                    [0.014812643, 0.081738919, 1.233338364, 1.243480165],
                ],
                [
                    [-0.745878234, 0.375413844, 0.790891204, 1.158014477],
                    [-0.803966599, 0.432258632, 0.457907671, 1.030100961],
                    [-0.418618204, -0.499032994, -1.024936914, 1.221879513],
                ],
            ],
        ),
        (
            ("J/psi(1S)"),
            ("pi0", "pi0", "pi0", "gamma"),
            [
                [
                    [0.037458949, 0.339629143, -0.369297399, 0.520913076],
                    [-0.569078090, 0.687702756, -0.760836072, 1.180624927],
                    [0.543652274, 0.220242315, -0.077206475, 0.606831154],
                ],
                [
                    [0.130561009, 0.299006221, -0.012444727, 0.353305116],
                    [0.123009165, 0.057692537, 0.033979586, 0.194507152],
                    [0.224048290, -0.156048645, 0.130817046, 0.331482507],
                ],
                [
                    [0.236609937, -0.366594420, 1.192296945, 1.276779728],
                    [0.571746863, -0.586304492, 1.051145223, 1.339317905],
                    [0.402982692, -0.697161285, 0.083274400, 0.820720580],
                ],
                [
                    [-0.404629896, -0.272040943, -0.810554818, 0.945902078],
                    [-0.125677938, -0.159090801, -0.324288738, 0.382450013],
                    [-1.170683257, 0.632967615, -0.136884971, 1.337865758],
                ],
            ],
        ),
        (
            "J/psi(1S)",
            ("pi0", "pi0", "pi0", "pi0", "gamma"),
            [
                [
                    [0.715439409, -0.284844373, -0.623772405, 1.000150296],
                    [0.134562969, 0.189723778, 0.229578969, 0.353592342],
                    [0.655088513, -0.205095150, -0.222905673, 0.734241552],
                ],
                [
                    [-0.062423993, 0.008278542, -0.516645045, 0.537685901],
                    [-0.075102421, -0.215361523, 0.351626927, 0.440319420],
                    [-0.569846157, -0.063070826, 0.199036046, 0.621720722],
                ],
                [
                    [-0.190428491, -0.002167052, 0.540188288, 0.588463958],
                    [-0.114856586, -0.554777459, -0.515051054, 0.777474366],
                    [-0.120958419, 0.236101553, -0.455239823, 0.543908922],
                ],
                [
                    [-0.286712460, -0.089479316, 0.393698133, 0.513251926],
                    [0.536198573, -0.215753382, -0.007385008, 0.593575359],
                    [-0.442948181, -0.261969339, 0.187557768, 0.564116725],
                ],
                [
                    [-0.175874464, 0.368212199, 0.206531028, 0.457347916],
                    [-0.480802535, 0.796168585, -0.058769834, 0.931938511],
                    [0.478664245, 0.294033763, 0.291551681, 0.632912076],
                ],
            ],
        ),
    ],
)
def test_generate_phsp(
    initial_state_names, final_state_names, expected_sample, pdg
):
    reaction_info = ReactionInfo(
        initial_state={
            i: pdg[name]
            for i, name in zip(
                range(-len(initial_state_names) - 1, 0), initial_state_names
            )
        },
        final_state={
            i: pdg[name]
            for i, name in zip(
                range(-len(final_state_names) - 1, 0), final_state_names
            )
        },
    )
    kin = HelicityKinematics(reaction_info)
    sample_size = 3
    rng = TFUniformRealNumberGenerator(seed=0)
    sample = generate_phsp(sample_size, kin, random_generator=rng)
    assert sample.shape == (len(final_state_names), sample_size, 4)
    assert pytest.approx(sample, abs=1e-8) == expected_sample
